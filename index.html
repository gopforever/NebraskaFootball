<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Nebraska Football — History Hub (Perf+Caching)</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap">
  <style>
    :root{
      --bg:#0b0d10; --panel:#12161b; --panel-2:#171c22; --text:#e9eef5; --muted:#a9b3c2;
      --accent:#d00000; --ok:#29c667; --bad:#f25555; --chip:#222831; --ring:#263241;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{ margin:0; background:linear-gradient(180deg,#0b0d10,#0e1318); color:var(--text); font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; }
    header{ position:sticky; top:0; z-index:50; backdrop-filter: blur(6px); background:rgba(11,13,16,.75); border-bottom:1px solid #12171f; }
    .bar{ max-width:1200px; margin:0 auto; padding:14px 16px; display:flex; gap:12px; align-items:center; flex-wrap:wrap}
    .logo{display:flex; align-items:center; gap:10px; font-weight:800; letter-spacing:.4px}
    .logo-badge{ width:34px; height:34px; border-radius:8px; display:grid; place-items:center; background:radial-gradient(90px 50px at -10% 120%,#ff2d2d,#d00000 60%,#880000); box-shadow: 0 6px 20px rgba(208,0,0,.45), inset 0 0 0 1px rgba(255,255,255,.09); font-weight:900; }
    .pill{ display:inline-flex; align-items:center; gap:8px; padding:8px 10px; border-radius:12px; background:var(--chip); color:var(--muted); font-size:13px; border:1px solid var(--ring); }
    .controls{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    select, input[type="number"], button{ font-family:inherit }
    select, input[type="number"]{ background:var(--panel); border:1px solid var(--ring); color:var(--text); padding:8px 10px; border-radius:10px; }
    .btn{ background:linear-gradient(180deg,#ff6868,#d00000); color:#fff; border:none; border-radius:10px; padding:10px 12px; cursor:pointer; font-weight:700; box-shadow:0 8px 26px rgba(208,0,0,.35); }
    .btn.secondary{background:#1e2630; border:1px solid var(--ring); box-shadow:none; color:#d8e1ee}
    .layout{max-width:1200px; margin:16px auto; display:grid; grid-template-columns: 340px 1fr; gap:16px; padding:0 16px 24px}
    aside{ background:var(--panel); border:1px solid var(--ring); border-radius:16px; overflow:hidden; }
    .aside-head{padding:12px 14px; display:flex; gap:8px; align-items:center; justify-content:space-between; border-bottom:1px solid var(--ring); background:var(--panel-2)}
    .aside-body{max-height:70vh; overflow:auto}
    .season-list{list-style:none;margin:0;padding:0}
    .season-list li{ display:flex; align-items:center; justify-content:space-between; padding:10px 12px; border-bottom:1px solid rgba(255,255,255,.04); cursor:pointer; transition:background .15s ease; }
    .season-list li:hover{background:#151b22}
    .season-list li.active{background:linear-gradient(90deg, rgba(208,0,0,.18), transparent 60%); border-left:3px solid var(--accent)}
    .season-list small{color:var(--muted)}
    main{ background:var(--panel); border:1px solid var(--ring); border-radius:16px; overflow:hidden; }
    .main-head{display:flex; align-items:center; justify-content:space-between; padding:14px; background:var(--panel-2); border-bottom:1px solid var(--ring)}
    .main-title{display:flex; align-items:center; gap:10px}
    .tag{font-size:12px; padding:6px 10px; border-radius:999px; background:#19222c; color:#b9c2d0; border:1px solid var(--ring)}
    .record{display:flex; gap:10px; align-items:center}
    .record .w{color:var(--ok)} .record .l{color:var(--bad)} .record .t{color:#e8c454}
    .table-wrap{max-height:66vh; overflow:auto}
    table{width:100%; border-collapse:collapse; font-size:14px}
    thead th{position:sticky; top:0; z-index:2; background:#0f151b; border-bottom:1px solid var(--ring); text-align:left; padding:10px 12px}
    tbody td{border-bottom:1px solid rgba(255,255,255,.05); padding:10px 12px}
    tbody tr:hover{background:#121a21}
    .chip{display:inline-block; padding:3px 8px; border-radius:10px; background:#1e2630; border:1px solid var(--ring); color:#a9b3c2; font-size:12px}
    .home{color:#9dd5ff} .away{color:#ffc899} .bowl{color:#ffd36b}
    .progress{height:10px; background:#0e141a; border-radius:999px; overflow:hidden; border:1px solid var(--ring); width:220px}
    .barfill{height:100%; background:linear-gradient(90deg,#ff7b7b,#d00000); width:0%}
    .era-buttons{display:flex; flex-wrap:wrap; gap:8px; padding:8px}
    .era-buttons button{ background:#1e2630; border:1px solid var(--ring); color:#d8e1ee; border-radius:10px; padding:6px 10px; cursor:pointer }
    footer{max-width:1200px;margin:18px auto 40px; color:#a9b3c2; font-size:12px; text-align:center}
    .muted{color:#a9b3c2}
    @media (max-width:1000px){.layout{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <header>
    <div class="bar">
      <div class="logo">
        <div class="logo-badge">N</div>
        <div>Nebraska Football — History Hub</div>
      </div>

      <div class="pill" id="apiStatus"><span id="apiStatusText">API: not connected</span></div>

      <div class="controls">
        <div class="progress" title="Preload progress"><div class="barfill" id="barfill"></div></div>
        <div class="pill">Loaded: <strong id="loadedCount">0</strong>/<span id="totalToLoad">0</span></div>
        <label class="pill">Concurrency
          <input id="concurrency" type="number" min="1" max="8" value="4" style="width:64px;margin-left:6px">
        </label>
        <button class="btn secondary" id="clearCacheBtn" title="Clear cached seasons">Clear Cache</button>
        <button class="btn secondary" id="changeKeyBtn" title="Change API Key">API Key</button>
      </div>
    </div>
  </header>

  <div class="layout">
    <aside>
      <div class="aside-head">
        <div><strong>Seasons</strong> <span class="muted">1890–present</span></div>
        <div class="pill" id="leftMsg">Idle</div>
      </div>
      <div class="era-buttons">
        <button data-era="last10">Last 10</button>
        <button data-era="last25">Last 25</button>
        <button data-era="bigten">Big Ten Era (2011–Now)</button>
        <button data-era="big12">Big 12 Era (1996–2010)</button>
        <button data-era="osborne">Osborne Era (1973–1997)</button>
        <button data-era="devaney">Devaney Era (1962–1972)</button>
        <button data-era="all">All</button>
      </div>
      <div class="aside-body">
        <ul class="season-list" id="seasonList"></ul>
      </div>
      <div class="muted" style="padding:12px;border-top:1px solid var(--ring)">
        Click a season to view instantly from cache (if present). Background refresh updates results silently.
      </div>
    </aside>

    <main>
      <div class="main-head">
        <div class="main-title">
          <h2 id="seasonTitle" style="margin:0;font-size:18px">Select a season</h2>
          <span class="tag" id="seasonMeta">—</span>
        </div>
        <div class="record">
          <div class="tag">W-L-T: <span class="w" id="w">0</span> - <span class="l" id="l">0</span> - <span class="t" id="t">0</span></div>
          <div class="tag">Conference: <span id="conf">—</span></div>
        </div>
      </div>

      <div class="table-wrap">
        <table id="gamesTable">
          <thead>
            <tr>
              <th>Week</th>
              <th>Date</th>
              <th>Opponent</th>
              <th>Home/Away</th>
              <th>Conference</th>
              <th>Score</th>
              <th>Result</th>
              <th>Venue</th>
              <th>Type</th>
            </tr>
          </thead>
          <tbody id="gamesBody">
            <tr><td colspan="9" class="muted" style="padding:18px">No season selected.</td></tr>
          </tbody>
        </table>
      </div>
    </main>
  </div>

  <footer>
    Background refresh (SWR) + IndexedDB caching. Era-based preload buttons included.
  </footer>

  <script>
    // ------------------ Utilities ------------------
    const $ = s => document.querySelector(s);
    const el = (t,c,txt)=>{const e=document.createElement(t); if(c) e.className=c; if(txt) e.textContent=txt; return e;};
    const wait = ms => new Promise(r=>setTimeout(r,ms));
    const nowIso = ()=> new Date().toISOString();
    function jitter(ms){ return ms + Math.floor(Math.random()*ms*0.25); }
    function shallowEqual(a,b){ try{return JSON.stringify(a)===JSON.stringify(b);}catch{return false;} }

    // ------------------ IndexedDB ------------------
    const DB_NAME = "cfbdCache"; const STORE = "seasons";
    function idbOpen(){
      return new Promise((resolve,reject)=>{
        const req = indexedDB.open(DB_NAME,2);
        req.onupgradeneeded = (e)=>{ const db=e.target.result; if(!db.objectStoreNames.contains(STORE)) db.createObjectStore(STORE); };
        req.onerror = ()=> reject(req.error);
        req.onsuccess = ()=> resolve(req.result);
      });
    }
    async function idbGet(key){
      const db = await idbOpen(); return new Promise((resolve,reject)=>{
        const tx = db.transaction(STORE,"readonly"); const st = tx.objectStore(STORE);
        const req = st.get(key);
        req.onsuccess = ()=> resolve(req.result || null);
        req.onerror = ()=> reject(req.error);
      });
    }
    async function idbSet(key, val){
      const db = await idbOpen(); return new Promise((resolve,reject)=>{
        const tx = db.transaction(STORE,"readwrite"); const st = tx.objectStore(STORE);
        const req = st.put(val, key);
        req.onsuccess = ()=> resolve(true);
        req.onerror = ()=> reject(req.error);
      });
    }
    async function idbClear(){
      const db = await idbOpen(); return new Promise((resolve,reject)=>{
        const tx = db.transaction(STORE,"readwrite"); const st = tx.objectStore(STORE);
        const req = st.clear();
        req.onsuccess = ()=> resolve(true);
        req.onerror = ()=> reject(req.error);
      });
    }

    // ------------------ API ------------------
    const CFBD = {
      base: "https://api.collegefootballdata.com",
      async get(path, params={}, attempt=0){
        const key = localStorage.getItem("cfbd_key");
        if(!key) throw new Error("Missing CFBD API key");
        const url = new URL(this.base + path);
        Object.entries(params).forEach(([k,v])=> v!=null && url.searchParams.set(k,v));
        const res = await fetch(url, { headers: { "Authorization": "Bearer " + key }});
        if(res.status === 429 || res.status >= 500){
          if(attempt < 5){
            const backoff = jitter(400 * Math.pow(2, attempt));
            $("#apiStatusText").textContent = `Retrying ${attempt+1}/5 in ${Math.ceil(backoff/1000)}s…`;
            await wait(backoff);
            return this.get(path, params, attempt+1);
          }
          const txt = await res.text();
          throw new Error(`CFBD ${res.status}: ${txt}`);
        }
        if(!res.ok){
          const txt = await res.text();
          throw new Error(`CFBD ${res.status}: ${txt}`);
        }
        return res.json();
      }
    };

    // ------------------ State ------------------
    const state = {
      startYear: 1890,
      endYear: new Date().getFullYear(),
      mem: new Map(),    // year -> { games, cachedAt }
      selected: null
    };

    function setApiStatus(msg){ $("#apiStatusText").textContent = msg; }
    function setLeft(msg){ $("#leftMsg").textContent = msg; }

    $("#changeKeyBtn").addEventListener("click", ()=>{
      const v = prompt("Paste your CollegeFootballData API key (stored locally):", localStorage.getItem("cfbd_key") || "");
      if(v){ localStorage.setItem("cfbd_key", v.trim()); setApiStatus("Key saved."); }
    });
    $("#clearCacheBtn").addEventListener("click", async ()=>{
      await idbClear(); state.mem.clear(); setApiStatus("Cache cleared"); alert("Local cache cleared.");
    });

    // ------------------ Queue ------------------
    class Queue{
      constructor(max=4){ this.max=max; this.running=0; this.q=[]; }
      push(fn){ return new Promise((resolve,reject)=>{ this.q.push({fn,resolve,reject}); this.run(); }); }
      run(){
        while(this.running < this.max && this.q.length){
          const {fn,resolve,reject} = this.q.shift();
          this.running++;
          fn().then(resolve).catch(reject).finally(()=>{ this.running--; this.run(); });
        }
      }
    }
    const queue = new Queue(4);
    $("#concurrency").addEventListener("change", e=>{ queue.max = Math.max(1, Math.min(8, parseInt(e.target.value,10)||4)); });

    // ------------------ Seasons UI ------------------
    function buildSeasonList(){
      const ul = $("#seasonList"); ul.innerHTML="";
      for(let y=state.endYear; y>=state.startYear; y--){
        const li = el("li");
        const left = el("div","", y.toString());
        const right = el("small","muted","");
        li.append(left,right);
        li.addEventListener("click", ()=> selectSeason(y, li, right));
        ul.appendChild(li);
      }
      // auto-select most recent season
      const first = ul.querySelector("li"); if(first) first.click();
    }

    // Map eras to ranges
    function eraRange(era){
      const end = state.endYear;
      if(era==="last10") return [end-9, end];
      if(era==="last25") return [end-24, end];
      if(era==="bigten") return [2011, end];
      if(era==="big12") return [1996, 2010];
      if(era==="osborne") return [1973, 1997];
      if(era==="devaney") return [1962, 1972];
      if(era==="all") return [state.startYear, end];
      return [end-9, end];
    }

    document.querySelectorAll(".era-buttons button").forEach(b=>{
      b.addEventListener("click", ()=> {
        const [start, end] = eraRange(b.dataset.era);
        startPreload(start, end);
      });
    });

    // ------------------ SWR Loaders ------------------
    async function fetchSeason(year){
      const [reg, post] = await Promise.all([
        CFBD.get("/games", { year, seasonType: "regular", team: "Nebraska" }),
        CFBD.get("/games", { year, seasonType: "postseason", team: "Nebraska" })
      ]);
      const games = [...reg, ...post].sort((a,b)=> new Date(a.startDate) - new Date(b.startDate));
      return { games, cachedAt: nowIso() };
    }

    async function getSeasonFromCache(year){
      const raw = await idbGet(`games-${year}`);
      if(!raw) return null;
      try { return JSON.parse(raw); } catch { return null; }
    }

    async function setSeasonCache(year, payload){
      await idbSet(`games-${year}`, JSON.stringify(payload));
    }

    // Load preferred: return cached immediately if available, then revalidate in background
    async function loadSeasonSWR(year, {onUpdate}={}){
      // memory first
      if(state.mem.has(year)){
        const cached = state.mem.get(year);
        setTimeout(()=> revalidate(year, onUpdate), 0);
        return cached;
      }
      // idb then background revalidate
      const idb = await getSeasonFromCache(year);
      if(idb){
        state.mem.set(year, idb);
        setTimeout(()=> revalidate(year, onUpdate), 0);
        return idb;
      }
      // otherwise fetch fresh
      const fresh = await fetchSeason(year);
      state.mem.set(year, fresh);
      await setSeasonCache(year, fresh);
      return fresh;
    }

    async function revalidate(year, onUpdate){
      try{
        const fresh = await fetchSeason(year);
        const current = state.mem.get(year);
        if(!current || !shallowEqual(current.games, fresh.games)){
          state.mem.set(year, fresh);
          await setSeasonCache(year, fresh);
          if(typeof onUpdate === "function"){ onUpdate(fresh); }
          if(state.selected === year){ renderSeason(year, fresh.games); }
        }
      }catch(e){ /* silent revalidate errors */ }
    }

    async function selectSeason(year, li, rightEl){
      const ul = $("#seasonList"); [...ul.children].forEach(n=>n.classList.remove("active")); li.classList.add("active");
      $("#seasonTitle").textContent = `Season ${year}`; $("#seasonMeta").textContent = "…";
      setLeft("Loading (cache first)…"); setApiStatus("Loading…");
      try{
        const payload = await loadSeasonSWR(year, { onUpdate: (fresh)=> {
          if(state.selected === year){ renderSeason(year, fresh.games); }
        }});
        renderSeason(year, payload.games);
        rightEl.textContent = `${$("#w").textContent}-${$("#l").textContent}${($("#t").textContent!=="0")?'-'+$("#t").textContent:''}`;
        setLeft("Ready"); setApiStatus(`Cached: ${new Date(payload.cachedAt).toLocaleString()}`);
        state.selected = year;
      }catch(err){
        console.error(err);
        $("#gamesBody").innerHTML = `<tr><td colspan="9" class="muted" style="padding:18px">${err.message || "Failed to load season."}</td></tr>`;
        setLeft("Error"); setApiStatus("Error");
      }
    }

    function renderSeason(year, games){
      const body = $("#gamesBody"); body.innerHTML="";
      let w=0,l=0,t=0; const confSet = new Set();
      for(const g of games){
        const isHome = g.homeTeam === "Nebraska";
        const opp = isHome ? g.awayTeam : g.homeTeam;
        const oppConf = isHome ? g.awayConference : g.homeConference;
        const ha = isHome ? "Home" : (g.neutralSite ? "Neutral" : "Away");
        const type = g.seasonType === "postseason" ? (g.notes || "Bowl") : "Regular";
        const date = g.startDate ? new Date(g.startDate) : null;
        const week = g.week ?? "";
        const scoreKnown = (g.homePoints!=null && g.awayPoints!=null);
        const score = scoreKnown ? `${isHome?g.homePoints:g.awayPoints}–${isHome?g.awayPoints:g.homePoints}` : "—";
        const result = scoreKnown ? ((isHome?g.homePoints:g.awayPoints) > (isHome?g.awayPoints:g.homePoints) ? "W":"L") : "—";
        if(result==="W") w++; else if(result==="L") l++; else t++;
        const conf = isHome ? g.homeConference : g.awayConference; if(conf) confSet.add(conf);
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${week}</td>
          <td>${date? date.toLocaleDateString():""}</td>
          <td>${opp} ${oppConf?`<span class="chip">${oppConf}</span>`:""}</td>
          <td class="${isHome?'home':'away'}">${ha}</td>
          <td>${isHome ? (g.homeConference||"") : (g.awayConference||"")}</td>
          <td><strong>${score}</strong></td>
          <td class="${result==='W'?'w':'l'}">${result}</td>
          <td>${g.venue||""}</td>
          <td class="${g.seasonType==='postseason'?'bowl':''}">${type}</td>
        `;
        body.appendChild(tr);
      }
      $("#w").textContent = w; $("#l").textContent = l; $("#t").textContent = t; $("#conf").textContent = confSet.size? Array.from(confSet).join(", "):"—";
      $("#seasonMeta").textContent = `${games.length} game${games.length===1?"":"s"}`;
    }

    // ------------------ Era Preload ------------------
    async function startPreload(start, end){
      const years = []; for(let y=end; y>=start; y--) years.push(y);
      $("#totalToLoad").textContent = years.length.toString();
      let done=0; $("#loadedCount").textContent = "0"; $("#barfill").style.width = "0%";
      setApiStatus("Preloading…"); setLeft(`Queueing ${years.length} seasons…`);

      await Promise.all(years.map(year => queue.push(async ()=>{
        try{
          // SWR: get cached or fetch, then revalidate; but for preload we just ensure cache is warm
          const cached = await getSeasonFromCache(year);
          if(!cached){
            const payload = await fetchSeason(year);
            state.mem.set(year, payload);
            await setSeasonCache(year, payload);
          }
        }catch(e){
          // ignore individual failures; retries already applied in fetchSeason via CFBD.get
        }finally{
          done++; $("#loadedCount").textContent = String(done);
          $("#barfill").style.width = Math.round(done/years.length*100) + "%";
        }
      })));

      setApiStatus("Preload complete");
      setLeft("Ready");
      // if nothing selected, select most recent within the range
      if(state.selected==null){
        const ul = $("#seasonList"); const first = ul.querySelector("li"); if(first) first.click();
      }
    }

    // ------------------ Init ------------------
    (function init(){
      if(localStorage.getItem("cfbd_key")) setApiStatus("Key found");
      else {
        const key = prompt("Enter your CollegeFootballData API key:");
        if(key){ localStorage.setItem("cfbd_key", key.trim()); setApiStatus("Key saved"); }
      }
      buildSeasonList();
      setLeft("Idle");
    })();
  </script>
</body>
</html>
